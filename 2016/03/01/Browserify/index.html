<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Browserify · Hexo of Tilly Vally @ GitHub</title><meta name="description" content="A Blog Powered By Hexo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/jekyll.css"><!--[if lt IE 9]>
<script src="js/html5shiv.min.js"></script>
<script src="js/respond.min.js"></script>
<![endif]--></head><body><header class="row-flex-row limit-width vh-center"><a href="/" class="logo"><img src="/favicon.png"></a><nav><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-link">主页</a></li><li class="nav-list-item"><a href="/archives/" class="nav-link active">   博客</a></li><li class="nav-list-item"><a href="/atom.xml" class="nav-link">rss</a></li><li class="nav-list-item"><a href="https://github.com/xxxxx" target="_blank" class="nav-link">   github</a></li></ul></nav></header><div class="container limit-width"><section class="row-flex-row"><div class="post"><article class="post-block"><h2 class="post-title"><a href="/2016/03/01/Browserify/" class="post-title-link">Browserify</a></h2><div class="post-meta"><ul class="post-tag-list"><li class="post-tag-item"><a href="/tags/Browserify/" class="post-tag-link">Browserify</a></li><li class="post-tag-item"><a href="/tags/JavaScript/" class="post-tag-link">JavaScript</a></li></ul><div class="post-time">星期五, 七月 15日 2016</div></div><div class="post-content"><p><strong>Browserify</strong>是JavaScript一种模块加载器， 作为代码的一个<strong>pre-processor</strong>,提供当前语言缺乏的对浏览器内导入模块的支持。与CSS的扩展如<strong>SASS</strong>和<strong>LESS</strong>为样式表增加语法支持相似，<strong>Browserify</strong>递归扫描源代码中的全局<code>require()</code>函数调用，增强客户端JavaScript应用。当<strong>Browserify</strong>找到这样的调用时，立刻加载被引用的模块（使用Node.js中的同一个<code>require()</code>函数），将它们组合为单个精简文件-一个bundle-可被加载到浏览器中。</p>
<p>这种简单但简洁的方式，把<strong>CommonJS</strong>（Node.js中加载模块的方式）的能力和方便带给浏览器，同时也完成了<strong>Asynchronous Module Definition (AMD)</strong> loaders如<strong>RequireJS</strong>所需的复杂性和代码引用.</p>
<h2 id="AMD_API__u4E0E_CommonJS"><a href="#AMD_API__u4E0E_CommonJS" class="headerlink" title="AMD API 与 CommonJS"></a>AMD API 与 CommonJS</h2><p>AMD API是一种解决JavaScript当前缺乏对inline加载外部模块支持的巧妙方法。AMD API通常被称为“浏览器优先”方法，每个被加载的模块被打包在一个回调函数中，然后被按需异步加载（例如lazy loaded），以达到把模块加载到浏览器的目标。如Listing 6-1所示。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Listing <span class="number">6</span>-<span class="number">1.</span> Defining and Requiring an AMD Module</span><br><span class="line"><span class="comment">// requirejs-example/public/app/weather.js</span></span><br><span class="line">define([], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> &#123;</span><br><span class="line">		<span class="string">'getForecast'</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			<span class="built_in">document</span>.getElementById(<span class="string">'forecast'</span>).innerHTML = <span class="string">'Partly cloudy.'</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// requirejs-example/public/app/index.js</span></span><br><span class="line">define([<span class="string">'weather'</span>], <span class="function"><span class="keyword">function</span>(<span class="params">weather</span>) </span>&#123;</span><br><span class="line">	weather.getForecast();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>AMD API虽然巧妙有效，但有点笨拙啰嗦。理想的情况是，在不增加复杂度的情况下，引用所需的外部模块和模板代码。<strong>CommonJS</strong>是广为人知的解决方法。</p>
<h2 id="Browserify_u5B89_u88C5"><a href="#Browserify_u5B89_u88C5" class="headerlink" title="Browserify安装"></a>Browserify安装</h2><p>Browserify命令行工具，是npm的一个包，安装过程如Listing 6-2.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Listing <span class="number">6</span>-<span class="number">2</span>. Installing the browserify Command-Line Utility via npm</span><br><span class="line">$ npm install -g browserify</span><br><span class="line">$ browserify --version</span><br><span class="line"><span class="number">10.2</span>.<span class="number">4</span></span><br></pre></td></tr></table></figure></p>
<p><em>注意：这里<code>Browerify</code>被安装在全局上下文环境，通常命令行工具都在全局环境下安装。</em></p>
<h2 id="u521B_u5EFA_u7B2C_u4E00_u4E2ABundle"><a href="#u521B_u5EFA_u7B2C_u4E00_u4E2ABundle" class="headerlink" title="创建第一个Bundle"></a>创建第一个Bundle</h2><p>对Browserify的多数诉求归于简洁。对CommonJS和Node非常熟悉的JavaScript开发者马上发现他们回家了。Listing 6-3是基于CommonJS的与 Listing 6-1 （基于RequireJS）同样功能的应用。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Listing <span class="number">6</span>-<span class="number">3.</span> Front-End Application That Requires Modules via CommonJS</span><br><span class="line"><span class="comment">// simple/public/app/index.js</span></span><br><span class="line"><span class="keyword">var</span> weather = <span class="built_in">require</span>(<span class="string">'./weather'</span>);</span><br><span class="line">weather.getForecast();</span><br><span class="line"></span><br><span class="line"><span class="comment">// simple/public/app/weather.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">	<span class="string">'getForecast'</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="built_in">document</span>.getElementById(<span class="string">'forecast'</span>).innerHTML = <span class="string">'Partly cloudy.'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这段代码不能直接在浏览器中运行（基于RequireJS的可以），因为浏览器没有内建机制通过<code>require()</code>函数加载模块。必须先通过<strong>browserify</strong>命令行工具或<strong>Browserify API</strong>编译进bundle中。使用命令行工具编译的命令如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ browserify app/index.js -o public/dist/app.js</span><br></pre></td></tr></table></figure></p>
<p>应用的主文件路径<code>public/app/index.js</code>，被传递给browserify工具 main file, 输出被限定保存到<code>public/dist/app.js</code>，在Listing 6-4 中被引用.<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Listing 6-4. HTML File Referencing Our Compiled Browserify Bundle</span><br><span class="line">// simple/public/index.html</span><br><span class="line"><span class="doctype">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">meta</span> <span class="attribute">charset</span>=<span class="value">"utf-8"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">meta</span> <span class="attribute">http-equiv</span>=<span class="value">"X-UA-Compatible"</span> <span class="attribute">content</span>=<span class="value">"IE=edge"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">meta</span> <span class="attribute">name</span>=<span class="value">"viewport"</span> <span class="attribute">content</span>=<span class="value">"width=device-width, initial-scale=1"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">title</span>&gt;</span>Browserify - Simple Example<span class="tag">&lt;/<span class="title">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">"forecast"</span>&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"/dist/app.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>通过<strong>Browser API</strong>可将此过程集成进更大型的build过程（例如通过Grunt这样的工具）。 Listing6-5是这个例子计划的<code>browserify</code> Grunt任务。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Listing <span class="number">6</span>-<span class="number">5.</span> Grunt Task That Compiles the Application via Browserify’s API</span><br><span class="line"><span class="comment">// simple/tasks/browserify.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">grunt</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">	grunt.registerTask(<span class="string">'browserify'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> done = <span class="keyword">this</span>.async();</span><br><span class="line">		<span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line">		<span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line">		<span class="keyword">var</span> src = path.join(<span class="string">'public'</span>, <span class="string">'app'</span>, <span class="string">'index.js'</span>);</span><br><span class="line">		<span class="keyword">var</span> target = path.join(<span class="string">'public'</span>, <span class="string">'dist'</span>, <span class="string">'app.js'</span>);</span><br><span class="line">		<span class="keyword">var</span> browserify = <span class="built_in">require</span>(<span class="string">'browserify'</span>)([src]);</span><br><span class="line">		browserify.bundle(<span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (err) <span class="keyword">return</span> grunt.fail.fatal(err);</span><br><span class="line">			grunt.file.mkdir(path.join(<span class="string">'public'</span>, <span class="string">'dist'</span>));</span><br><span class="line">			fs.writeFileSync(target, data);</span><br><span class="line">			done();</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h2 id="u53D1_u751F_u53D8_u5316_u521B_u5EFA_u65B0_u7684Bundles"><a href="#u53D1_u751F_u53D8_u5316_u521B_u5EFA_u65B0_u7684Bundles" class="headerlink" title="发生变化创建新的Bundles"></a>发生变化创建新的Bundles</h2><p>使用Browserify的计划不能直接在浏览器中运行，必须首先编译。要有效使用这一工具，计划必须被设定为在源码发生变化自动触发编译。有两种实现方式。</p>
<h3 id="u76D1_u63A7_u6587_u4EF6_u53D8_u5316"><a href="#u76D1_u63A7_u6587_u4EF6_u53D8_u5316" class="headerlink" title="监控文件变化"></a>监控文件变化</h3><p><code>grunt-contrib-watch</code>可用于在源码发生变化时触发build过程。Listing 6-6是一个例子。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ grunt</span><br><span class="line">Running <span class="string">"browserify"</span> task</span><br><span class="line"></span><br><span class="line">Running <span class="string">"concurrent:serve"</span> (concurrent) task</span><br><span class="line">	Running <span class="string">"watch"</span> task</span><br><span class="line">	Waiting...</span><br><span class="line">	Running <span class="string">"server"</span> task</span><br><span class="line">	App is now available at: http://localhost:<span class="number">7000</span></span><br><span class="line">	&gt;&gt; File <span class="string">"app/index.js"</span> changed.</span><br><span class="line">	Running <span class="string">"browserify"</span> task</span><br><span class="line"></span><br><span class="line">	Done, without errors.</span><br><span class="line">	Completed <span class="keyword">in</span> <span class="number">0.615</span>s at Fri Jun <span class="number">26</span> <span class="number">2015</span> <span class="number">08</span>:<span class="number">31</span>:<span class="number">25</span> GMT-<span class="number">0500</span> (CDT) - Waiting...</span><br></pre></td></tr></table></figure></p>
<p>在这个例子中，默认的Grunt任务触发三个步骤：</p>
<ul>
<li>立即创建一个Browserify bundle.</li>
<li>启动一个web服务器，作为当前project的主机.</li>
<li>执行当侦测到源码发生变化时创建新Browserify Bundles的监控脚本</li>
</ul>
<p>这种简单方式对大多数小计划足够用了。但当小计划演进为大计划后，build过程的时间不断增加，等待时间变长。Browserify的姊妹应用<strong>Watchify</strong>对这类情况有所帮助。</p>
<h2 id="u4F7F_u7528Watchify_u76D1_u63A7_u6587_u4EF6_u53D8_u5316"><a href="#u4F7F_u7528Watchify_u76D1_u63A7_u6587_u4EF6_u53D8_u5316" class="headerlink" title="使用Watchify监控文件变化"></a>使用Watchify监控文件变化</h2><p>当<strong>Watchify</strong>被调用时，首先编译应用为一个整体，但是在过程完成后并不退出，而是继续运行，监控源代码路径下的文件变化。当侦测到变化发生时，<strong>Watchify</strong>只编译发生变化的文件，因此编译时间大缩短。<strong>Watchify</strong>在每次编译时维护自己内部的缓存机制。要实现<strong>Browserify</strong>, <strong>Watchify</strong>可通过命令行或API调用。在<strong>Listing 6-7</strong>中, <em>simple</em>计划通过<strong>Watchify</strong>的命令行工具编译。<code>-v</code>参数指定<strong>Watchify</strong>以<code>verbose</code>模式运行. 作为结果，<strong>Watchify</strong>告知有变化发生。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Listing <span class="number">6</span>-<span class="number">7</span>. Installing Watchify via npm and Running It Against simple Project</span><br><span class="line">$ npm install -g watchify</span><br><span class="line">$ watchify public/app/index.js -o public/dist/app.js -v</span><br><span class="line"><span class="number">778</span> bytes written to public/dist/app.js (<span class="number">0.03</span> seconds)</span><br><span class="line"><span class="number">786</span> bytes written to public/dist/app.js (<span class="number">0.01</span> seconds)</span><br></pre></td></tr></table></figure>
<p><strong>Watchify</strong>也提供了API，以用于大型编译过程集成(如 Listing 6-8). 只需对<code>Listing 6-7</code>稍加改动.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">Listing <span class="number">6</span>-<span class="number">8.</span> Grunt Task Demonstrating the Use <span class="keyword">of</span> Watchify’s API</span><br><span class="line"><span class="comment">// simple/tasks/watchify.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">grunt</span>) </span>&#123;</span><br><span class="line">	grunt.registerTask(<span class="string">'watchify'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> done = <span class="keyword">this</span>.async();</span><br><span class="line">		<span class="keyword">var</span> browserify = <span class="built_in">require</span>(<span class="string">'browserify'</span>);</span><br><span class="line">		<span class="keyword">var</span> watchify = <span class="built_in">require</span>(<span class="string">'watchify'</span>);</span><br><span class="line">		<span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line">		<span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line">		<span class="keyword">var</span> src = path.join(<span class="string">'public'</span>, <span class="string">'app'</span>, <span class="string">'index.js'</span>);</span><br><span class="line">		<span class="keyword">var</span> target = path.join(<span class="string">'public'</span>, <span class="string">'dist'</span>, <span class="string">'app.js'</span>);</span><br><span class="line">		<span class="keyword">var</span> targetDir = path.join(<span class="string">'public'</span>, <span class="string">'dist'</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">var</span> browserify = browserify(&#123;</span><br><span class="line">			<span class="string">'cache'</span>: &#123;&#125;,</span><br><span class="line">			<span class="string">'packageCache'</span>: &#123;&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		browserify = watchify(browserify);</span><br><span class="line">		browserify.add(src);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">var</span> compile = <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (err) <span class="keyword">return</span> grunt.log.error(err);</span><br><span class="line">			<span class="keyword">if</span> (!data) <span class="keyword">return</span> grunt.log.error(<span class="string">'No data'</span>);</span><br><span class="line">			grunt.file.mkdir(targetDir);</span><br><span class="line">			fs.writeFileSync(target, data);</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		browserify.bundle(compile);</span><br><span class="line"></span><br><span class="line">		browserify.on(<span class="string">'update'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			browserify.bundle(compile);</span><br><span class="line">		&#125;);</span><br><span class="line">		</span><br><span class="line">		browserify.on(<span class="string">'log'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">			grunt.log.oklns(msg);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h2 id="Using_Multiple_Bundles"><a href="#Using_Multiple_Bundles" class="headerlink" title="Using Multiple Bundles"></a>Using Multiple Bundles</h2><p>通常应用的自有代码只占编译代码的一小部分，大部分是第三方库（如Angular, jQuery,Lodash等等），不会经常变化。因此，可将应用的编译分为两部分：自有代码与第三方库，分别编译。</p>
<p>例如<code>extracted</code>计划与<code>advanced</code>计划基本一样，除了一点：<code>extracted</code>编译过程创建了两个独立的<strong>Browserify</strong> bundles，而不是一个:</p>
<ul>
<li>/dist/vendor.js: 第三方依赖</li>
<li>/dist/app.js: 应用定制代码<br>通过这种方法，浏览器可有效地在更新发布时获取新计划。换句话说，因为变化在应用定制代码内发生，浏览器只需重新下载<code>/dist/app.js</code>. 与<code>advanced</code>计划对比一下，当（不论多么小）变化发生时， 每次更新都需要重新下载整个bundle.</li>
</ul>
<p><code>Listing 6-9</code>是<code>extracted</code>计划的HTML文件，其中引用了两个独立的bundles：<code>/dist/vendor.js</code>和<code>/dist/app.js</code>.<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Listing 6-9. HTML for This Chapter’s extracted Project</span><br><span class="line">// extracted/public/index.html</span><br><span class="line"><span class="doctype">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">html</span> <span class="attribute">ng-app</span>=<span class="value">"app"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">meta</span> <span class="attribute">charset</span>=<span class="value">"utf-8"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">meta</span> <span class="attribute">http-equiv</span>=<span class="value">"X-UA-Compatible"</span> <span class="attribute">content</span>=<span class="value">"IE=edge"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">meta</span> <span class="attribute">name</span>=<span class="value">"viewport"</span> <span class="attribute">content</span>=<span class="value">"width=device-width, initial-scale=1"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">title</span>&gt;</span>Browserify - Advanced Example<span class="tag">&lt;/<span class="title">title</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">link</span> <span class="attribute">rel</span>=<span class="value">"stylesheet"</span> <span class="attribute">href</span>=<span class="value">"/css/style.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">body</span> <span class="attribute">class</span>=<span class="value">"container"</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="title">navbar</span> <span class="attribute">ng-if</span>=<span class="value">"user_id"</span>&gt;</span><span class="tag">&lt;/<span class="title">navbar</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="title">div</span> <span class="attribute">ng-view</span>&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="title">footer</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"/disc.html"</span>&gt;</span>View this project's dependency tree<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">footer</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"/dist/vendor.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"/dist/app.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><code>Listing 6-10</code> 是<code>extracted</code>计划的Gruntfile. 注意一个特殊的配置项(browserify.vendor_modules)的值。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Listing <span class="number">6</span>-<span class="number">10.</span> Gruntfile <span class="keyword">for</span> This Chapter’s extracted Project</span><br><span class="line"><span class="comment">// extracted/Gruntfile.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">grunt</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">	grunt.initConfig(&#123;</span><br><span class="line">		<span class="string">'browserify'</span>: &#123;</span><br><span class="line">			<span class="string">'vendor_modules'</span>: [</span><br><span class="line">				<span class="string">'angular'</span>,</span><br><span class="line">				<span class="string">'bootstrap-sass'</span>,</span><br><span class="line">				<span class="string">'jquery'</span>,</span><br><span class="line">				<span class="string">'angular-route'</span>,</span><br><span class="line">				<span class="string">'angular-sanitize'</span>,</span><br><span class="line">				<span class="string">'restangular'</span>,</span><br><span class="line">				<span class="string">'jquery.cookie'</span>,</span><br><span class="line">				<span class="string">'lodash'</span>,</span><br><span class="line">				<span class="string">'underscore.string'</span>,</span><br><span class="line">				<span class="string">'lodash-deep'</span></span><br><span class="line">			]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	grunt.loadTasks(<span class="string">'tasks'</span>);</span><br><span class="line"></span><br><span class="line">	grunt.registerTask(<span class="string">'default'</span>, [<span class="string">'compass'</span>, <span class="string">'browserify'</span>, <span class="string">'browserify-vendor'</span>, <span class="string">'init-db'</span>,</span><br><span class="line">		<span class="string">'concurrent'</span>]);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><code>Listing 6-11</code>是<code>extracted</code>计划的<code>browserify Grunt task</code>的内容. 该任务很大程度上模仿了<code>advanced</code>计划的对应任务，除了一点例外。该任务遍历该计划的Gruntfile中定义的第三方模块，<strong>Browserify</strong>被设置为从编译bundle中排除这引用的模块。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Listing <span class="number">6</span>-<span class="number">11.</span> The extracted Project’s browserify Grunt Task</span><br><span class="line"><span class="comment">// extracted/tasks/browserify.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">grunt</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">	grunt.registerTask(<span class="string">'browserify'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> done = <span class="keyword">this</span>.async();</span><br><span class="line">		<span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line">		<span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line">		<span class="keyword">var</span> target = path.join(<span class="string">'public'</span>, <span class="string">'dist'</span>, <span class="string">'app.js'</span>);</span><br><span class="line">		<span class="keyword">var</span> vendorModules = grunt.config.get(<span class="string">'browserify.vendor_modules'</span>) || [];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> browserify = <span class="built_in">require</span>(<span class="string">'browserify'</span>)([</span><br><span class="line">			path.join(<span class="string">'app'</span>, <span class="string">'index.js'</span>)</span><br><span class="line">		], &#123;</span><br><span class="line">			<span class="string">'paths'</span>: [<span class="string">'app'</span>],</span><br><span class="line">			<span class="string">'fullPaths'</span>: <span class="literal">true</span>,</span><br><span class="line">			<span class="string">'bundleExternal'</span>: <span class="literal">true</span></span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">		vendorModules.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">vm</span>) </span>&#123;</span><br><span class="line">			grunt.log.writelns(<span class="string">'Excluding module from application bundle: %s'</span>, vm);</span><br><span class="line">			browserify.exclude(vm);</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">		browserify.bundle(<span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (err) <span class="keyword">return</span> grunt.fail.fatal(err);</span><br><span class="line">			grunt.file.mkdir(path.join(<span class="string">'public'</span>, <span class="string">'dist'</span>));</span><br><span class="line">			fs.writeFileSync(target, data);</span><br><span class="line">			grunt.task.run(<span class="string">'disc'</span>);</span><br><span class="line">			done();</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><code>Listing 6-12</code>是<code>extracted</code>计划的<code>browserify-vendor Grunt task</code>的内容.这个任务创建一个独立的Browserify bundle，只由<code>Listing 6-10</code>中定义的第三方模块组成。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Listing <span class="number">6</span>-<span class="number">12.</span> The extracted Project’s browserify-vendor Grunt Task</span><br><span class="line"><span class="comment">// extracted/tasks/browserify-vendor.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">grunt</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">	grunt.registerTask(<span class="string">'browserify-vendor'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> done = <span class="keyword">this</span>.async();</span><br><span class="line">		<span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line">		<span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line">		<span class="keyword">var</span> target = path.join(<span class="string">'public'</span>, <span class="string">'dist'</span>, <span class="string">'vendor.js'</span>);</span><br><span class="line">		<span class="keyword">var</span> vendorModules = grunt.config.get(<span class="string">'browserify.vendor_modules'</span>) || [];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> browserify = <span class="built_in">require</span>(<span class="string">'browserify'</span>)(&#123;</span><br><span class="line">			<span class="string">'paths'</span>: [</span><br><span class="line">				<span class="string">'app'</span></span><br><span class="line">			],</span><br><span class="line">			<span class="string">'fullPaths'</span>: <span class="literal">true</span></span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">		vendorModules.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">vm</span>) </span>&#123;</span><br><span class="line">			browserify.require(vm);</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">		browserify.bundle(<span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (err) <span class="keyword">return</span> grunt.fail.fatal(err);</span><br><span class="line">			grunt.file.mkdir(path.join(<span class="string">'public'</span>, <span class="string">'dist'</span>));</span><br><span class="line">			fs.writeFileSync(target, data);</span><br><span class="line">			done();</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>在<code>extracted</code>计划路径下运行<code>$ npm start</code>. 缺少的npm modules会自动安装，计划的默认Grunt任务会执行，两个独立的bundles被创建。包含定制代码的bundle是<code>/dist/app.js</code>,文件大小减少。</p>
<h2 id="The_Node_Way"><a href="#The_Node_Way" class="headerlink" title="The Node Way"></a>The Node Way</h2><p><strong>Browserify</strong>调用全局<code>require()</code>函数，递归扫描源码路径，加载引用的模块进行编译。这个函数与<strong>Node</strong>的<code>require()</code>函数是同一个。之后，<strong>Browserify</strong>将其合并为一个bundle供浏览器加载。</p>
<p>就这一点而言，使用Browserify的计划可被当作客户端侧的Node应用。许多方面令初学者感到困惑，但以这种方式思考就可以理解。其中两点是：模块解析和依赖管理。</p>
<h3 id="u6A21_u5757_u89E3_u6790_u548CNODE_PATH__u73AF_u5883_u53D8_u91CF"><a href="#u6A21_u5757_u89E3_u6790_u548CNODE_PATH__u73AF_u5883_u53D8_u91CF" class="headerlink" title="模块解析和NODE_PATH 环境变量"></a>模块解析和NODE_PATH 环境变量</h3><p>Node应用可以多种方式引用模块。例如，通过模块对于应用的相对路径require它：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> animals = <span class="built_in">require</span>(<span class="string">'./lib/animals'</span>);</span><br></pre></td></tr></table></figure></p>
<p>相似地，也可以通过绝对路径进行引用。这两种方法里，Node查找模块的位置都相当明确。而下面这个通过名称进行引用的例子，位置信息没有直接提供：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> animals = <span class="built_in">require</span>(<span class="string">'animals'</span>);</span><br></pre></td></tr></table></figure></p>
<p>在这种情况，Node首先尝试在核心库中定位模块，这个过程可通过Node加载文件系统模块<code>fs</code>观察到。如果没找到，Node接着搜索名为<code>node_modules</code>的文件夹, 起始位置为调用<code>require()</code>函数的模块，逐级向上。当找到文件夹时，Node查找是否含有被请求的模块（或包）。这个过程一直持续，直到找到为止。如果没有找到，则会抛出异常。</p>
<p>但是，Node也提供了指定模块搜索的<code>additional</code>文件夹的方式，避免查找结果为空的情况。</p>
<p><code>Listing 6-13</code>是<code>path-env</code>计划的<code>package.json</code>文件节选。其中已指定的<code>start</code>的部分非常重要。根据其中的设定，当<code>$ npm start</code>执行时，在应用运行前，<strong>NODE_PATH</strong>环境变量被更新以包含对该计划的<code>/lib</code>文件夹的引用。作为结果，Node将其加入解析模块时要搜索的文件夹。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Listing 6-13. This Project&#8217;s npm start Script Updates the NODE_PATH Environment Variable&#10;// path-env/package.json&#10;&#123;&#10;&#9;&#34;name&#34;: &#34;path-env&#34;,&#10;&#9;&#34;version&#34;: &#34;1.0.0&#34;,&#10;&#9;&#34;main&#34;: &#34;./bin/index.js&#34;,&#10;&#9;&#34;scripts&#34;: &#123;&#10;&#9;&#9;&#34;start&#34;: &#34;export NODE_PATH=$NODE_PATH:./lib &#38;&#38; node ./bin/index.js&#34;&#10;&#9;&#125;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<p>设置<strong>NODE_PATH</strong>环境变量，可为较复杂计划的整洁和可维护性带来明显的正面效应。因为从本质上来说，这种方法创建了一个命名空间，应用的模块（并不是作为npm管理的包）可通过命名空间以名称方式引用，而不用通过冗长的相对路径。<code>Listing 6-14</code>是一个实际应用当中的例子。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Listing <span class="number">6</span>-<span class="number">14.</span> Several <span class="keyword">of</span> the Modules Contained Within the path-env Project</span><br><span class="line"><span class="comment">// path-env/bin/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> api = <span class="built_in">require</span>(<span class="string">'app/api'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// path-env/lib/app/api/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> animals = <span class="built_in">require</span>(<span class="string">'app/models/animal'</span>);</span><br><span class="line">app.use(<span class="string">'/'</span>, express.static(path.join(__dirname, <span class="string">'..'</span>, <span class="string">'..'</span>, <span class="string">'..'</span>, <span class="string">'public'</span>)));</span><br><span class="line">app.get(<span class="string">'/animals'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">	res.send(animals);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">7000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'App is now available at: http://localhost:7000'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">module</span>.exports = app;</span><br><span class="line"></span><br><span class="line"><span class="comment">// path-env/lib/app/models/animal/index.js</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">	<span class="string">'Aardvarks'</span>, <span class="string">'Cats'</span>, <span class="string">'Dogs'</span>, <span class="string">'Lemurs'</span>, <span class="string">'Three-Toed Sloths'</span>, <span class="string">'Zebras'</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure></p>
<p>这个例子没有对相对路径模块的引用。计划的主script, <code>bin/index.js</code>, 通过<code>require(&#39;app/api&#39;)；</code>加载一个定制模块以初始化Express; 另一种方式是通过相对路径: <code>require(&#39;../lib/app/api&#39;)；</code>. 在复杂的Node计划中常常会遇到诸如<code>require(&#39;../../../../models/animal&#39;)</code>这样的模块引用场景，这时就能体会到这种方法的好处。</p>
<hr>
<p>■■<strong>注意</strong> 重点要记住使用<strong>NODE_PATH</strong>环境变量，只对当前Node（或Browserify）应用有意义，而不是作为一个package. 当创建一个可重复使用的package时，只能依赖于Node的默认模块解析方式。</p>
<hr>
<h3 id="u5728Browserify_u4E2D_u5229_u7528NODE_PATH"><a href="#u5728Browserify_u4E2D_u5229_u7528NODE_PATH" class="headerlink" title="在Browserify中利用NODE_PATH"></a>在Browserify中利用NODE_PATH</h3><p>目前为止，我们已明了<strong>NODE_PATH</strong>在服务器端Node应用中的积极作用。以此为基础，可将这一概念应用到客户端Browserify编译的基于浏览器的应用。<br><code>Listing 6-15</code>是<code>advanced</code>计划的browserify Grunt task，负责通过Browserify API编译应用。其中重要的是<code>paths</code>选项的使用，可在编译开始前为<strong>Browserify</strong>提供一组附加到<strong>NODE_PATH</strong>环境变量的路径。就是这个设置项使我们可以轻松实现前述章节中的优点。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Listing <span class="number">6</span>-<span class="number">15.</span> The browserify Grunt Task <span class="keyword">for</span> This Chapter’s advanced Project</span><br><span class="line"></span><br><span class="line"><span class="comment">// advanced/tasks/browserify.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">grunt</span>) </span>&#123;</span><br><span class="line">	grunt.registerTask(<span class="string">'browserify'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> done = <span class="keyword">this</span>.async();</span><br><span class="line">		<span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line">		<span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line">		<span class="keyword">var</span> target = path.join(<span class="string">'public'</span>, <span class="string">'dist'</span>, <span class="string">'app.js'</span>);</span><br><span class="line">		<span class="keyword">var</span> browserify = <span class="built_in">require</span>(<span class="string">'browserify'</span>)([</span><br><span class="line">			path.join(<span class="string">'app'</span>, <span class="string">'index.js'</span>)</span><br><span class="line">		], &#123;</span><br><span class="line">			<span class="string">'paths'</span>: [</span><br><span class="line">				<span class="string">'app'</span></span><br><span class="line">		],</span><br><span class="line">		<span class="string">'fullPaths'</span>: <span class="literal">true</span></span><br><span class="line">	&#125;);</span><br><span class="line">	browserify.bundle(<span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (err) <span class="keyword">return</span> grunt.fail.fatal(err);</span><br><span class="line">			grunt.file.mkdir(path.join(<span class="string">'public'</span>, <span class="string">'dist'</span>));</span><br><span class="line">			fs.writeFileSync(target, data);</span><br><span class="line">			grunt.task.run(<span class="string">'disc'</span>);</span><br><span class="line">			done();</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><code>Listing 6-16</code>中一个小模块负责加载<code>lodash</code>并集成两个第三方工具<code>underscore.string</code>和<code>lodash-deep</code>. 最后的输出值是包含三个模块功能的单一对象。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Listing <span class="number">6</span>-<span class="number">16.</span> Module Responsible <span class="keyword">for</span> Loading Lodash and Integrating Various Third-Party Plugins</span><br><span class="line"></span><br><span class="line"><span class="comment">// advanced/app/utils/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>);</span><br><span class="line">_.mixin(<span class="built_in">require</span>(<span class="string">'underscore.string'</span>));</span><br><span class="line">_.mixin(<span class="built_in">require</span>(<span class="string">'lodash-deep'</span>));</span><br><span class="line"><span class="built_in">module</span>.exports = _;</span><br></pre></td></tr></table></figure></p>
<p><code>paths</code>的值被提供给Browserify, 应用可从任何位置通过调用<code>require(&#39;app/utils&#39;);</code>引用这个模块.</p>
<p>###　依赖管理<br>直到近期，“dependency management”这一提法一直(在大多数情况下) 是客户端侧基于浏览器应用的执行环境的一个外部概念.但这一趋势正在迅速改变，这大部分归功于Node及构建在其上的附加功能(例如Bower, Grunt, and Yeoman等)的迅速普及.</p>
<p>在依赖管理方面，<strong>Bower</strong>为客户端开发人员提供了易于使用的机制以管理应用依赖的不同的第三方库。对于新手或不使用客户端侧编译器如Browserify的开发人员，<strong>Bower</strong>一直并将继续作为一个管理依赖的可选项。但是， 相对于Browserify的优点,Bower显得有点老了。</p>
<p>在依赖管理方面，<em>使用Browserify的计划最好被当作客户端侧Node应用</em>，这一陈述更显恰当。回想一下Browserify的编译过程，源码被扫描以查找对全局<code>require()</code>函数的调用。这些调用在Node中执行，返回值可被客户端应用使用。这里有一个重要的暗示，即当使用Browserify时,开发人员只依赖Node的包管理npm，依赖管理被显著简化。虽然从技术上可以做到指令Browserify加载根据Bower安装的packages，但一般不干这样划不来的事。</p>
<h2 id="u5B9A_u4E49Browser-Specific_Modules"><a href="#u5B9A_u4E49Browser-Specific_Modules" class="headerlink" title="定义Browser-Specific Modules"></a>定义Browser-Specific Modules</h2><p>创建一个新模块，并通过npm发布共享，模块可在Node和浏览器中使用。要实现这一目标，<strong>Browserify</strong>在计划的<code>package.json</code>文件中提供了<code>browser</code> 配置选项。这个选项允许开发人员覆盖用于定位模块的位置信息。</p>
<p><code>Listing 6-17</code>中的package,有两个模块：<code>lib/node.js</code>和<code>lib/browser.js</code>. 参考这个package的<code>package.json</code>文件，其主模块是<code>lib/node.js</code>. 换句话说，当这个package在Node中通过名字被引用时，它就是Node要加载的模块。但需要注意的是，一个额外的选项在这里被配置：<code>&quot;browser&quot;: &quot;./lib/browser.js&quot;</code>. 根据这一选项，Browserify将加载这一模块，而不是由主模块指定的模块。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Listing 6-17. Module Exposing Two Distinct Entry Points: One for Node, the Other for Browserify</span><br><span class="line"></span><br><span class="line">// browser1/package.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	"name": "browser1",</span><br><span class="line">	"version": "1.0.0",</span><br><span class="line">	"main": "./lib/node.js",</span><br><span class="line">	"browser": "./lib/browser.js"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// browser1/lib/browser.js</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">	'run': function() &#123;</span><br><span class="line">		console.log('I am running within a browser.');</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// browser1/lib/node.js</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">	'run': function() &#123;</span><br><span class="line">		console.log('I am running within Node.');</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>Browserify的<code>browser</code>配置选项不限定为简单地覆盖package的<code>main</code>模块的位置，也可用于覆盖多个模块位置。在<code>Listing 6-18</code>中，<code>package.json</code>文件中的<code>browser</code>选项不是字符串，而是一个对象，这样可以指定多重browser-specific覆盖。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Listing 6-18. Module Exposing Multiple, Distinct Modules for Node and Browserify</span><br><span class="line">// browser2/package.json</span><br><span class="line">&#123;</span><br><span class="line">	"name": "browser2",</span><br><span class="line">	"version": "1.0.0",</span><br><span class="line">	"main": "./lib/node.js",</span><br><span class="line">	"browser": &#123;</span><br><span class="line">		"./lib/node.js": "./lib/browser.js",</span><br><span class="line">		"./lib/extra.js": "./lib/extra-browser.js"</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如<code>Listing 6-17</code>所展现的那样, 这种模式的模块会在其自身暴露两个区别的入口：一个用于Node，一个用于通过Browserify编译的应用。这个例子在这个概念更进一步。当模块被编译时，如果试图加载位于<code>lib/extra.js</code>的模块, 那么相反位于<code>lib/extra-browser</code>被替代。 这种方式下，<code>browser</code>设置选项可创建这样的模块：其功能在Node与在浏览器中差异巨大。</p>
<h2 id="u53D8_u5F62_u4EE5_u6269_u5C55Browserify"><a href="#u53D8_u5F62_u4EE5_u6269_u5C55Browserify" class="headerlink" title="变形以扩展Browserify"></a>变形以扩展Browserify</h2><p>开发人员可在新bundles创建的编译过程中创建称为<code>transforms</code>的插件，以编译Browserify的核心功能。这类transforms经由npm安装，并在其名称被包含到应用的<code>package.json</code>文件中的<code>browserify.transform</code>数组之中后启用</p>
<h3 id="brfs"><a href="#brfs" class="headerlink" title="brfs"></a>brfs</h3><p>brfs变换简化了内联加载文件内容过程。它扩展Browserify编译过程，以搜索所有对<code>fs.readFileSync()</code>方法的调用。当找到该方法时，被引用文件的内容被立即加载并返回。<code>Listing 6-19</code>是<code>transforms-brfs</code>计划的<code>package.json</code>文件相关内容的摘录，<code>brfs</code>已安装并被包含到<code>browserify.transform</code>配置项中。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Listing 6-19. Excerpt from the package.json File for This Chapter’s transforms-brfs Project</span><br><span class="line"></span><br><span class="line">// transforms-brfs/package.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	"name": "transforms-brfs",</span><br><span class="line">	"dependencies": &#123;</span><br><span class="line">		"browserify": "^10.2.4",</span><br><span class="line">		"brfs": "^1.4.0"</span><br><span class="line">	&#125;,	</span><br><span class="line">	"browserify": &#123;</span><br><span class="line">		"transform": [</span><br><span class="line">			"brfs"</span><br><span class="line">		]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>Listing 6-20</code>是该计划的<code>/app/index.js</code>模块。<code>brfs</code>变换将加载<code>/app/templates/lorem.html</code>中的内容, 并赋给<code>tpl</code>变量。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Listing <span class="number">6</span>-<span class="number">20.</span> Loading a Template via fs.readFileSync()</span><br><span class="line"></span><br><span class="line"><span class="comment">// transforms-brfs/app/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> $ = <span class="built_in">require</span>(<span class="string">'jquery'</span>);</span><br><span class="line"><span class="keyword">var</span> tpl = fs.readFileSync(__dirname + <span class="string">'/templates/lorem.html'</span>, <span class="string">'utf8'</span>);</span><br><span class="line">$(<span class="string">'#container'</span>).html(tpl);</span><br></pre></td></tr></table></figure></p>
<h3 id="folderify"><a href="#folderify" class="headerlink" title="folderify"></a>folderify</h3><p>与<code>brfs</code>变换很像，<code>folderify</code>变换也可以加载多个内联文件内容,而不是一个文件。<code>Listing 6-21</code>是<code>transforms-folderify</code> 计划的内容。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Listing <span class="number">6</span>-<span class="number">21.</span> Loading the Contents <span class="keyword">of</span> Multiple Files <span class="keyword">with</span> folderify</span><br><span class="line"></span><br><span class="line"><span class="comment">// transforms-folderify/app/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> $ = <span class="built_in">require</span>(<span class="string">'jquery'</span>);</span><br><span class="line"><span class="keyword">var</span> includeFolder = <span class="built_in">require</span>(<span class="string">'include-folder'</span>);</span><br><span class="line"><span class="keyword">var</span> folder = includeFolder(__dirname + <span class="string">'/templates'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> k <span class="keyword">in</span> folder) &#123;</span><br><span class="line">	$(<span class="string">'#container'</span>).append(<span class="string">'&lt;p&gt;'</span> + k + <span class="string">': '</span> + folder[k] + <span class="string">'&lt;/p&gt;'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个例子的<code>package.json</code>文件需要在其<code>browserify.transform</code>数组中包含<code>folderify</code>。Browserify查找对<code>include-folder</code>模块的引用。当其返回的函数被调用时，Browserify将加载在指定路径下找到的每个文件，并以对象的形式返回。</p>
<h3 id="bulkify"><a href="#bulkify" class="headerlink" title="bulkify"></a>bulkify</h3><p><code>bulkify</code>变换可通过一次调用而导入多个模块。<code>Listing 6-22</code>是<code>transforms-bulkify</code>计划的主应用文件的节选。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Listing <span class="number">6</span>-<span class="number">22.</span> Main Application File <span class="keyword">for</span> This Chapter’s transforms-bulkify Project</span><br><span class="line"></span><br><span class="line"><span class="comment">// transforms-bulkify/app/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bulk = <span class="built_in">require</span>(<span class="string">'bulk-require'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = angular.module(<span class="string">'app'</span>, [</span><br><span class="line">	<span class="string">'ngRoute'</span></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> routes = bulk(__dirname, [</span><br><span class="line">	<span class="string">'routes/**/route.js'</span></span><br><span class="line">]).routes;</span><br><span class="line"></span><br><span class="line">app.config(<span class="function"><span class="keyword">function</span>(<span class="params">$routeProvider</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> defaultRoute = <span class="string">'dashboard'</span>;</span><br><span class="line"></span><br><span class="line">	_.each(routes, <span class="function"><span class="keyword">function</span>(<span class="params">route, route_name</span>) </span>&#123;</span><br><span class="line">		route = route.route;</span><br><span class="line">		route.config.resolve = route.config.resolve || &#123;&#125;;</span><br><span class="line">		$routeProvider.when(route.route, route.config);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	$routeProvider.otherwise(&#123;</span><br><span class="line">		<span class="string">'redirectTo'</span>: defaultRoute</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>这是一个<strong>Angular</strong>应用的例子。这里的重点是<code>bulk()</code>方法可以<code>require()</code>多个模块，匹配规则可以是一个或多个模式（例子中是<code>routes/**/route.js</code>）。<br>Figure 6-2 shows the file structure for this project. As you can see, the app/routes module contains<br>three folders, each representing a route within our Angular application. The bulkify transform has allowed<br>us to quickly require() each of these modules with a single call to bulk(). Afterward, we are able to iterate<br>over the resulting object and pass each route to Angular.</p>
<h3 id="Browserify-Shim"><a href="#Browserify-Shim" class="headerlink" title="Browserify-Shim"></a>Browserify-Shim</h3><p>在使用Browserify时，偶然会碰到引入不遵循CommonJS方式模块的情况。例如，第三方的<code>Foo</code>库，加载后同赋给全局<code>window.Foo</code>变量(Listing 6-23). 这样的库可通过<code>browserify-shim</code>变换来引入。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Listing <span class="number">6</span>-<span class="number">23.</span> Third-Party Foo Library That Assigns Itself to the Global Foo Variable</span><br><span class="line"></span><br><span class="line"><span class="comment">// transforms-shim/app/vendor/foo.js</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'Bar'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在使用npm将<code>browserify-shim</code>模块安装到当前域后，与前面的<code>Listing 6-19</code>例子一样，在应用的<code>package.json</code>文件中将其添加到变换列表中，以开启该模块功能。然后，在<code>package.json</code>的根层级创建一个<code>browserify-shim</code>对象，作为这个变换的配置对象使用。<code>Listing 6-24</code>中，对象的每个key代表一个不应暴露的模块路径，相应的值是全局变量。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Listing 6-24. Configuring browserify-shim Within a Project’s package.json File</span><br><span class="line"></span><br><span class="line">// transforms-shim/package.json</span><br><span class="line">// </span><br><span class="line">&#123;</span><br><span class="line">	"name": "transforms-shim",</span><br><span class="line">	"version": "1.0.0",</span><br><span class="line">	"main": "server.js",</span><br><span class="line">	"browserify": &#123;</span><br><span class="line">		"transform": [</span><br><span class="line">			"browserify-shim"</span><br><span class="line">		]</span><br><span class="line">	&#125;,</span><br><span class="line">	"browserify-shim": &#123;</span><br><span class="line">		"./app/vendor/foo.js": "Foo"</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当<code>browserify-shim</code>变换安装并配置后，位置<code>app/vendor/foo.js</code>的模块可通过<code>require()</code>正确引入。</p>
</div></article><div class="pagination"><a href="/2016/03/23/demystifying-javascript-closures-callbacks-iifes/" class="pagination-prev">PREV</a><a href="/2016/02/26/strict-mode/" class="pagination-next">NEXT</a></div></div><aside class="sidebar"><h3>分类标签</h3><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Angular/">Angular</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Browserify/">Browserify</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Callback/">Callback</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Closure/">Closure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Event/">Event</a></li></ul><h3>最新文章</h3><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/07/14/Table Layout in CSS/">Table Layout in CSS</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/14/Exam Analysis/">Exam Analysis</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/27/JQuery EasyUI Sourece Code Analysis/">JQuery EasyUI Sourece Code Analysis</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/25/AngularJS/">Angular</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/23/demystifying-javascript-closures-callbacks-iifes/">demystifying-javascript-closures-callbacks-iifes</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/01/Browserify/">Browserify</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/26/strict-mode/">strict mode</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/26/Try{} and Catch{}/">Try{} and Catch{}</a></li></ul></aside></section></div><div class="extra"></div><footer class="footer"><div class="row-flex-row limit-width vh-center"><div class="copyright"><P>© 2016 <a href="/">Tilly Vally</P></div><div class="power"><p><a href="http://pinggod.com/">Sean Sun</a>, 
<a href="https://hexo.io">Hexo</a>, 
<a href="https://github.com/">GitHub</a>, 
<a href="https://jekyllrb.com/">Jekyll</a></p></div></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?a36e15d9e2adec9a21fcdd9f686b1ed2";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>